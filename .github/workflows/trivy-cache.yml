name: Cache Trivy/Grype Vulnerability DB

on:
  schedule:
    - cron: '0 0 * * *'  # Runs every 24 hours
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:
  cache_vuln_db:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare cache directory
        run: |
         sudo mkdir -p /github/home/trivy-cache
         sudo chown -R $USER:$USER /github/home/trivy-cache

      - name: Cache vulnerability database
        id: cache
        uses: actions/cache@v4
        with:
          path: /github/home/trivy-cache/db  # Path to store the Trivy DB
          key: trivy-db-cache_${{ github.run_id }}

      - name: Download vulnerability DB
        if: steps.cache.outputs.cache-hit != 'true' 
        uses: docker://ghcr.io/aquasecurity/trivy:0.37.2
        with:
          entrypoint: trivy
          args: image --download-db-only --cache-dir /github/home/trivy-cache --debug 

      - name: Verify cache contents
        run: ls -la /github/home/trivy-cache/db  # Check if DB is downloaded